<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Family Vault OS | Security Edition</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <style>
        /* ==========================================================================
           1. –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê (CSS VARIABLES)
           ========================================================================== 
        */
        :root {
            --p-blue: #3b82f6;
            --p-blue-dark: #1d4ed8;
            --p-glow: rgba(59, 130, 246, 0.5);
            
            --bg-dark: #0f172a;
            --bg-panel: #1e293b;
            --bg-input: #334155;
            
            --text-white: #f8fafc;
            --text-dim: #94a3b8;
            
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            
            --radius-main: 24px;
            --radius-msg: 18px;
            
            --safe-t: env(safe-area-inset-top, 20px);
            --safe-b: env(safe-area-inset-bottom, 20px);

            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
        }

        [data-theme="light"] {
            --bg-dark: #f1f5f9;
            --bg-panel: #ffffff;
            --bg-input: #e2e8f0;
            --text-white: #0f172a;
            --text-dim: #64748b;
        }

        /* ==========================================================================
           2. –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò –ò –°–ë–†–û–°
           ========================================================================== 
        */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        html, body { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: var(--bg-dark); color: var(--text-white);
            font-family: 'Inter', sans-serif; overflow: hidden;
            user-select: none;
        }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--p-blue); border-radius: 10px; }

        /* ==========================================================================
           3. –≠–ö–†–ê–ù–´ (SCREENS)
           ========================================================================== 
        */
        .screen {
            position: fixed; inset: 0; display: none;
            flex-direction: column; z-index: 10;
            background: var(--bg-dark);
        }
        .screen.active { display: flex; animation: fadeIn 0.4s ease; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ==========================================================================
           4. –≠–ö–†–ê–ù –í–•–û–î–ê –ò –ó–ê–Ø–í–ö–ò
           ========================================================================== 
        */
        .auth-wrap {
            flex: 1; display: flex; align-items: center; justify-content: center;
            padding: 20px; background: radial-gradient(circle at top right, #1e1b4b, transparent);
        }
        .auth-card {
            width: 100%; max-width: 400px; background: var(--bg-panel);
            padding: 40px 30px; border-radius: var(--radius-main);
            box-shadow: var(--shadow-xl); text-align: center;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .auth-logo {
            font-size: 42px; font-weight: 900; margin-bottom: 10px;
            background: linear-gradient(to right, #60a5fa, #c084fc);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .input-box { width: 100%; margin-bottom: 20px; text-align: left; }
        .input-box label { display: block; margin-bottom: 8px; font-size: 12px; color: var(--text-dim); text-transform: uppercase; font-weight: 700; }
        .input-ui {
            width: 100%; padding: 16px; background: var(--bg-input);
            border-radius: 14px; border: 2px solid transparent;
            color: white; font-size: 16px; transition: 0.3s;
        }
        .input-ui:focus { border-color: var(--p-blue); background: var(--bg-dark); }

        .btn-ui {
            width: 100%; padding: 18px; border-radius: 14px; border: none;
            background: var(--p-blue); color: white; font-weight: 700; font-size: 16px;
            cursor: pointer; box-shadow: 0 10px 20px var(--p-glow); transition: 0.2s;
        }
        .btn-ui:active { transform: scale(0.97); }

        /* –≠–ö–†–ê–ù –û–ñ–ò–î–ê–ù–ò–Ø (PENDING) */
        #pending-screen {
            justify-content: center; align-items: center; text-align: center; padding: 40px;
        }
        .loader-dots { display: flex; gap: 8px; justify-content: center; margin: 20px 0; }
        .dot { width: 12px; height: 12px; background: var(--p-blue); border-radius: 50%; animation: bounce 1.4s infinite ease-in-out; }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* ==========================================================================
           5. –ì–õ–ê–í–ù–´–ô –ò–ù–¢–ï–†–§–ï–ô–° –ß–ê–¢–ê
           ========================================================================== 
        */
        .app-container { display: flex; flex-direction: column; height: 100%; }

        /* –®–ê–ü–ö–ê */
        .header {
            height: calc(65px + var(--safe-t)); padding-top: var(--safe-t);
            background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(15px);
            display: flex; align-items: center; padding-left: 15px; padding-right: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.05); z-index: 100;
        }
        .header-avatar { width: 42px; height: 42px; border-radius: 50%; border: 2px solid var(--p-blue); object-fit: cover; }
        .header-info { flex: 1; margin-left: 12px; }
        .h-title { font-weight: 800; font-size: 17px; }
        .h-status { font-size: 11px; color: var(--success); display: flex; align-items: center; gap: 5px; }
        .pulse-dot { width: 6px; height: 6px; background: var(--success); border-radius: 50%; box-shadow: 0 0 8px var(--success); }

        /* –°–ü–ò–°–û–ö –°–û–û–ë–©–ï–ù–ò–ô */
        #chat-flow {
            flex: 1; overflow-y: auto; padding: 20px 15px;
            display: flex; flex-direction: column; gap: 10px;
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
        }

        .msg-row { display: flex; flex-direction: column; max-width: 80%; position: relative; }
        .msg-row.me { align-self: flex-end; }
        .msg-row.other { align-self: flex-start; }

        .bubble {
            padding: 12px 16px; border-radius: var(--radius-msg);
            font-size: 15px; line-height: 1.5; position: relative;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            user-select: text;
        }
        .msg-row.me .bubble {
            background: linear-gradient(135deg, var(--p-blue) 0%, var(--p-blue-dark) 100%);
            color: white; border-bottom-right-radius: 4px;
        }
        .msg-row.other .bubble {
            background: var(--bg-panel); color: var(--text-white);
            border-bottom-left-radius: 4px; border: 1px solid rgba(255,255,255,0.05);
        }

        .sender-name { font-size: 11px; font-weight: 800; color: var(--p-blue); margin-bottom: 4px; margin-left: 5px; }
        .msg-time { font-size: 9px; opacity: 0.5; margin-top: 5px; text-align: right; font-family: 'JetBrains Mono'; }

        /* –ó–ê–ö–†–ï–ü */
        #pin-bar {
            background: rgba(59, 130, 246, 0.15); border-bottom: 1px solid var(--p-blue);
            padding: 10px 15px; display: none; align-items: center; gap: 12px;
            font-size: 13px; cursor: pointer;
        }

        /* –ü–û–õ–ï –í–í–û–î–ê */
        .input-area {
            background: var(--bg-panel); padding: 12px 15px calc(12px + var(--safe-b));
            border-top: 1px solid rgba(255,255,255,0.05);
        }
        .input-row { display: flex; align-items: flex-end; gap: 10px; }
        .field-container {
            flex: 1; background: var(--bg-input); border-radius: 20px;
            padding: 10px 15px; min-height: 44px; display: flex; align-items: center;
        }
        #msg-input {
            width: 100%; background: transparent; border: none; color: white;
            font-size: 16px; max-height: 120px; resize: none;
        }
        .circle-btn {
            width: 44px; height: 44px; border-radius: 50%; background: var(--p-blue);
            display: flex; align-items: center; justify-content: center; color: white;
            box-shadow: 0 4px 12px var(--p-glow); cursor: pointer;
        }

        /* ==========================================================================
           6. –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ (SECURITY HUB)
           ========================================================================== 
        */
        #admin-panel {
            position: fixed; inset: 0; background: var(--bg-dark); z-index: 500;
            display: none; flex-direction: column; padding-top: var(--safe-t);
        }
        .admin-header { padding: 20px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; }
        .admin-tabs { display: flex; background: var(--bg-panel); margin: 10px 20px; border-radius: 12px; padding: 5px; }
        .tab { flex: 1; padding: 10px; text-align: center; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .tab.active { background: var(--p-blue); color: white; }

        .request-card {
            background: var(--bg-panel); margin: 10px 20px; padding: 15px;
            border-radius: 16px; display: flex; align-items: center; gap: 15px;
            animation: flipInX 0.5s;
        }
        .req-info { flex: 1; }
        .req-actions { display: flex; gap: 10px; }
        .btn-approve { background: var(--success); color: white; border: none; padding: 8px 15px; border-radius: 8px; font-weight: 700; }
        .btn-ban { background: var(--danger); color: white; border: none; padding: 8px 15px; border-radius: 8px; font-weight: 700; }

        /* ==========================================================================
           7. –ö–û–ù–¢–ï–ö–°–¢–ù–û–ï –ú–ï–ù–Æ –ò –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
           ========================================================================== 
        */
        #ctx-menu {
            position: fixed; width: 200px; background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(10px); border-radius: 15px; z-index: 1000;
            display: none; box-shadow: var(--shadow-xl); border: 1px solid rgba(255,255,255,0.1);
        }
        .ctx-item { padding: 12px 15px; font-size: 14px; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .ctx-item:active { background: rgba(255,255,255,0.1); }
        .ctx-item.del { color: var(--danger); }

        .toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 10px 20px;
            border-radius: 20px; font-size: 13px; z-index: 2000; display: none;
        }

    </style>
</head>
<body>

    <div id="loading-screen" class="screen active center" style="justify-content:center; align-items:center;">
        <div class="auth-logo">VAULT</div>
        <div class="loader-dots">
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        </div>
    </div>

    <div id="auth-screen" class="screen">
        <div class="auth-wrap">
            <div class="auth-card">
                <div class="auth-logo">VAULT</div>
                <p style="color:var(--text-dim); margin-bottom:30px;">–°–∏—Å—Ç–µ–º–∞ –∑–∞—â–∏—â–µ–Ω–Ω–æ–π —Å–≤—è–∑–∏</p>
                
                <div style="margin-bottom:20px; position:relative; display:inline-block;">
                    <img id="p-ava" src="https://api.dicebear.com/7.x/notionists/svg?seed=Lucky" style="width:100px; height:100px; border-radius:50%; border:3px solid var(--p-blue);">
                    <label for="f-ava" style="position:absolute; bottom:0; right:0; background:var(--p-blue); width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer;"><i class="fas fa-camera" style="font-size:12px;"></i></label>
                    <input type="file" id="f-ava" hidden accept="image/*" onchange="ui.previewAva(this)">
                </div>

                <div class="input-box">
                    <label>–í–∞—à–µ –ò–º—è</label>
                    <input type="text" id="in-name" class="input-ui" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è..." oninput="logic.checkBoss(this.value)">
                </div>

                <div id="admin-pass-box" class="input-box" style="display:none;">
                    <label>–ö–ª—é—á –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</label>
                    <input type="password" id="in-pass" class="input-ui" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>

                <button class="btn-ui" onclick="logic.requestAccess()">–í–æ–π—Ç–∏ / –ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
            </div>
        </div>
    </div>

    <div id="pending-screen" class="screen">
        <i class="fas fa-shield-halved" style="font-size:60px; color:var(--warning); margin-bottom:20px;"></i>
        <h2>–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</h2>
        <p style="color:var(--text-dim); max-width:280px;">–¢–≤–æ—è –∑–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ <b>–î–µ–Ω–∏—Å—É</b>. –ü–æ–¥–æ–∂–¥–∏, –ø–æ–∫–∞ –æ–Ω –æ–¥–æ–±—Ä–∏—Ç –≤—Ö–æ–¥.</p>
        <div class="loader-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
        <button class="btn-ui" style="width:auto; background:transparent; box-shadow:none; color:var(--danger);" onclick="logic.logout()">–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É</button>
    </div>

    <div id="banned-screen" class="screen center" style="justify-content:center; align-items:center; text-align:center; padding:20px;">
        <i class="fas fa-user-slash" style="font-size:80px; color:var(--danger); margin-bottom:20px;"></i>
        <h1 style="color:var(--danger);">–¢–´ –í –ë–ê–ù–ï</h1>
        <p>–î–æ—Å—Ç—É–ø –∫ —ç—Ç–æ–º—É —Ö—Ä–∞–Ω–∏–ª–∏—â—É –¥–ª—è —Ç–µ–±—è –∑–∞–∫—Ä—ã—Ç –Ω–∞–≤—Å–µ–≥–¥–∞.</p>
    </div>

    <div id="app-screen" class="screen">
        <div class="app-container">
            <header class="header">
                <i class="fas fa-bars" style="font-size:20px; margin-right:15px; cursor:pointer;" onclick="ui.toggleDrawer()"></i>
                <img id="h-ava" class="header-avatar" src="">
                <div class="header-info">
                    <div class="h-title">–°–µ–º–µ–π–Ω—ã–π –°–∫–ª–µ–ø</div>
                    <div class="h-status"><div class="pulse-dot"></div> <span id="online-count">1 –≤ —Å–µ—Ç–∏</span></div>
                </div>
                <div class="h-actions">
                    <i class="fas fa-shield-heart" id="admin-icon" style="display:none; color:var(--warning); font-size:22px; cursor:pointer;" onclick="ui.openAdmin()"></i>
                </div>
            </header>

            <div id="pin-bar" onclick="logic.jumpToPin()">
                <i class="fas fa-thumbtack" style="color:var(--p-blue);"></i>
                <div id="pin-txt" style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...</div>
                <i class="fas fa-times" onclick="logic.unpin(event)"></i>
            </div>

            <div id="chat-flow">
                </div>

            <div class="input-area">
                <div id="reply-box" style="display:none; background:rgba(0,0,0,0.2); padding:8px; border-radius:10px; margin-bottom:10px; border-left:3px solid var(--p-blue);">
                    <div style="font-size:11px; font-weight:700; color:var(--p-blue);">–û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é <span id="reply-name"></span></div>
                    <div id="reply-text" style="font-size:12px; opacity:0.7; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;"></div>
                </div>
                <div class="input-row">
                    <label for="f-msg" class="circle-btn" style="background:var(--bg-input); box-shadow:none;"><i class="fas fa-plus"></i></label>
                    <input type="file" id="f-msg" hidden onchange="logic.sendMedia(this)">
                    
                    <div class="field-container">
                        <textarea id="msg-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å..." rows="1" oninput="ui.autoResize(this)"></textarea>
                    </div>

                    <div id="send-btn" class="circle-btn" onclick="logic.sendText()">
                        <i class="fas fa-paper-plane"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="admin-panel">
        <div class="admin-header">
            <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –î–æ—Å—Ç—É–ø–æ–º</h3>
            <i class="fas fa-times" style="font-size:24px; cursor:pointer;" onclick="ui.closeAdmin()"></i>
        </div>
        <div class="admin-tabs">
            <div class="tab active" onclick="ui.switchTab('reqs')">–ó–∞—è–≤–∫–∏ (<span id="req-count">0</span>)</div>
            <div class="tab" onclick="ui.switchTab('users')">–£—á–∞—Å—Ç–Ω–∏–∫–∏</div>
        </div>
        <div id="admin-content" style="flex:1; overflow-y:auto;">
            </div>
    </div>

    <div id="ctx-menu">
        <div class="ctx-item" onclick="logic.ctxReply()"><i class="fas fa-reply"></i> –û—Ç–≤–µ—Ç–∏—Ç—å</div>
        <div class="ctx-item" id="ctx-pin-btn" onclick="logic.ctxPin()"><i class="fas fa-thumbtack"></i> –ó–∞–∫—Ä–µ–ø–∏—Ç—å</div>
        <div class="ctx-item del" id="ctx-del-btn" onclick="logic.ctxDelete()"><i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å</div>
    </div>

    <div class="toast" id="toast"></div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        /**
         * ====================================================================
         * VAULT OS CORE ENGINE
         * ====================================================================
         */

        const config = {
            apiKey: "AIzaSyACp_gVvnpgF_P_0YpKXR5E8QeSTcLEA88",
            projectId: "familychat-4125b",
            adminName: "–î–µ–Ω–∏—Å",
            adminKey: "qwaszx12"
        };

        firebase.initializeApp({
            apiKey: config.apiKey,
            authDomain: config.projectId + ".firebaseapp.com",
            projectId: config.projectId,
            storageBucket: config.projectId + ".appspot.com"
        });

        const db = firebase.firestore();
        
        // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        let user = JSON.parse(localStorage.getItem('vault_user')) || null;
        let activeTab = 'reqs';
        let replyData = null;
        let currentCtxId = null;

        const ui = {
            showScreen: (id) => {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(id).classList.add('active');
            },
            
            toast: (txt) => {
                const t = document.getElementById('toast');
                t.innerText = txt;
                t.style.display = 'block';
                setTimeout(() => t.style.display = 'none', 2000);
            },

            previewAva: (input) => {
                const reader = new FileReader();
                reader.onload = e => document.getElementById('p-ava').src = e.target.result;
                reader.readAsDataURL(input.files[0]);
            },

            autoResize: (el) => {
                el.style.height = 'auto';
                el.style.height = el.scrollHeight + 'px';
            },

            openAdmin: () => document.getElementById('admin-panel').style.display = 'flex',
            closeAdmin: () => document.getElementById('admin-panel').style.display = 'none',

            switchTab: (tab) => {
                activeTab = tab;
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                event.target.classList.add('active');
                logic.renderAdmin();
            }
        };

        const logic = {
            init: async () => {
                if (!user) {
                    ui.showScreen('auth-screen');
                } else {
                    logic.verifyStatus();
                }
            },

            checkBoss: (val) => {
                const box = document.getElementById('admin-pass-box');
                box.style.display = (val.trim().toLowerCase() === config.adminName.toLowerCase()) ? 'block' : 'none';
            },

            requestAccess: async () => {
                const name = document.getElementById('in-name').value.trim();
                const pass = document.getElementById('in-pass').value.trim();
                const ava = document.getElementById('p-ava').src;

                if (!name) return ui.toast("–í–≤–µ–¥–∏—Ç–µ –∏–º—è");

                let isAdmin = false;
                if (name.toLowerCase() === config.adminName.toLowerCase()) {
                    if (pass !== config.adminKey) return ui.toast("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á –∞–¥–º–∏–Ω–∞");
                    isAdmin = true;
                }

                const uid = name.toLowerCase() + "_" + Math.floor(Math.random() * 1000);
                const userData = {
                    uid, name, ava, isAdmin,
                    status: isAdmin ? 'approved' : 'pending',
                    lastSeen: Date.now()
                };

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase
                await db.collection('vault_users').doc(uid).set(userData);
                
                user = userData;
                localStorage.setItem('vault_user', JSON.stringify(user));
                logic.verifyStatus();
            },

            // –ì–õ–ê–í–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò
            verifyStatus: () => {
                db.collection('vault_users').doc(user.uid).onSnapshot(doc => {
                    if (!doc.exists) {
                        logic.logout();
                        return;
                    }
                    const d = doc.data();
                    if (d.status === 'banned') ui.showScreen('banned-screen');
                    else if (d.status === 'pending') ui.showScreen('pending-screen');
                    else if (d.status === 'approved') {
                        ui.showScreen('app-screen');
                        logic.startApp();
                    }
                });
            },

            startApp: () => {
                document.getElementById('h-ava').src = user.ava;
                if (user.isAdmin) {
                    document.getElementById('admin-icon').style.display = 'block';
                    logic.listenAdminData();
                }
                logic.listenMessages();
                logic.listenPresence();
                logic.listenPins();
                setInterval(logic.updatePresence, 30000);
            },

            listenMessages: () => {
                const flow = document.getElementById('chat-flow');
                db.collection('vault_msgs').orderBy('ts', 'asc').limitToLast(50).onSnapshot(snap => {
                    snap.docChanges().forEach(change => {
                        if (change.type === 'added') logic.renderMsg(change.doc);
                        if (change.type === 'removed') document.getElementById('msg-' + change.doc.id)?.remove();
                    });
                    flow.scrollTop = flow.scrollHeight;
                });
            },

            renderMsg: (doc) => {
                const d = doc.data();
                const id = doc.id;
                const isMe = d.author_uid === user.uid;
                const flow = document.getElementById('chat-flow');

                const row = document.createElement('div');
                row.className = `msg-row ${isMe ? 'me' : 'other'}`;
                row.id = 'msg-' + id;

                let content = '';
                if (d.reply) {
                    content += `<div style="font-size:10px; opacity:0.6; border-left:2px solid var(--p-blue); padding-left:5px; margin-bottom:5px;">
                        <b>${d.reply.name}:</b> ${d.reply.text}
                    </div>`;
                }

                if (d.type === 'text') content += `<div>${d.body}</div>`;
                else if (d.type === 'img') content += `<img src="${d.body}" style="width:100%; border-radius:10px; margin-top:5px;" onclick="window.open(this.src)">`;

                const time = d.ts ? new Date(d.ts.toDate()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '--:--';

                row.innerHTML = `
                    ${!isMe ? `<div class="sender-name">${d.author}</div>` : ''}
                    <div class="bubble">
                        ${content}
                        <div class="msg-time">${time} ${d.pinned ? 'üìå' : ''}</div>
                    </div>
                `;

                // Long press / Right click
                row.oncontextmenu = (e) => logic.openCtx(e, id, isMe, d.pinned);
                
                // –ú–æ–±–∏–ª—å–Ω—ã–π Long Press
                let timer;
                row.ontouchstart = (e) => { timer = setTimeout(() => logic.openCtx(e.touches[0], id, isMe, d.pinned), 600); };
                row.ontouchend = () => clearTimeout(timer);

                flow.appendChild(row);
            },

            sendText: async () => {
                const inp = document.getElementById('msg-input');
                const val = inp.value.trim();
                if (!val) return;

                const msg = {
                    author: user.name,
                    author_uid: user.uid,
                    body: val,
                    type: 'text',
                    ts: firebase.firestore.FieldValue.serverTimestamp(),
                    reply: replyData
                };

                inp.value = '';
                ui.autoResize(inp);
                logic.cancelReply();
                await db.collection('vault_msgs').add(msg);
            },

            sendMedia: (input) => {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    await db.collection('vault_msgs').add({
                        author: user.name,
                        author_uid: user.uid,
                        body: e.target.result,
                        type: 'img',
                        ts: firebase.firestore.FieldValue.serverTimestamp()
                    });
                };
                reader.readAsDataURL(file);
            },

            // –ê–î–ú–ò–ù-–õ–û–ì–ò–ö–ê
            listenAdminData: () => {
                db.collection('vault_users').where('status', '==', 'pending').onSnapshot(snap => {
                    document.getElementById('req-count').innerText = snap.size;
                    if (activeTab === 'reqs') logic.renderAdmin();
                });
            },

            renderAdmin: async () => {
                const container = document.getElementById('admin-content');
                container.innerHTML = '<div style="padding:20px; text-align:center;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
                
                if (activeTab === 'reqs') {
                    const snap = await db.collection('vault_users').where('status', '==', 'pending').get();
                    container.innerHTML = '';
                    if (snap.empty) container.innerHTML = '<p style="text-align:center; margin-top:20px; color:gray;">–ù–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫ –Ω–µ—Ç</p>';
                    snap.forEach(doc => {
                        const d = doc.data();
                        container.innerHTML += `
                            <div class="request-card">
                                <img src="${d.ava}" style="width:40px; height:40px; border-radius:50%;">
                                <div class="req-info">
                                    <b>${d.name}</b><br><small>${d.uid}</small>
                                </div>
                                <div class="req-actions">
                                    <button class="btn-approve" onclick="logic.updateUserStatus('${d.uid}', 'approved')">–û–¥–æ–±—Ä–∏—Ç—å</button>
                                    <button class="btn-ban" onclick="logic.updateUserStatus('${d.uid}', 'banned')">–í –ë–∞–Ω</button>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    const snap = await db.collection('vault_users').where('status', '==', 'approved').get();
                    container.innerHTML = '';
                    snap.forEach(doc => {
                        const d = doc.data();
                        container.innerHTML += `
                            <div class="request-card">
                                <img src="${d.ava}" style="width:40px; height:40px; border-radius:50%;">
                                <div class="req-info">
                                    <b>${d.name}</b> ${d.uid === user.uid ? '(–í—ã)' : ''}
                                </div>
                                ${d.uid !== user.uid ? `<button class="btn-ban" onclick="logic.updateUserStatus('${d.uid}', 'banned')">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
                            </div>
                        `;
                    });
                }
            },

            updateUserStatus: async (uid, status) => {
                await db.collection('vault_users').doc(uid).update({ status });
                logic.renderAdmin();
                ui.toast(status === 'approved' ? "–î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω" : "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω");
            },

            // –ö–û–ù–¢–ï–ö–°–¢–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø
            openCtx: (e, id, isMe, isPinned) => {
                e.preventDefault?.();
                currentCtxId = id;
                const menu = document.getElementById('ctx-menu');
                menu.style.display = 'block';
                menu.style.left = e.clientX + 'px';
                menu.style.top = e.clientY + 'px';

                document.getElementById('ctx-del-btn').style.display = (isMe || user.isAdmin) ? 'flex' : 'none';
                document.getElementById('ctx-pin-btn').style.display = user.isAdmin ? 'flex' : 'none';
                document.getElementById('ctx-pin-btn').innerHTML = isPinned ? '<i class="fas fa-times"></i> –û—Ç–∫—Ä–µ–ø–∏—Ç—å' : '<i class="fas fa-thumbtack"></i> –ó–∞–∫—Ä–µ–ø–∏—Ç—å';

                setTimeout(() => document.onclick = () => { menu.style.display = 'none'; document.onclick = null; }, 100);
            },

            ctxReply: async () => {
                const doc = await db.collection('vault_msgs').doc(currentCtxId).get();
                const d = doc.data();
                replyData = { name: d.author, text: d.type === 'text' ? d.body : '[–ú–µ–¥–∏–∞]' };
                document.getElementById('reply-box').style.display = 'block';
                document.getElementById('reply-name').innerText = d.author;
                document.getElementById('reply-text').innerText = replyData.text;
                document.getElementById('msg-input').focus();
            },

            cancelReply: () => {
                replyData = null;
                document.getElementById('reply-box').style.display = 'none';
            },

            ctxPin: async () => {
                const docRef = db.collection('vault_msgs').doc(currentCtxId);
                const doc = await docRef.get();
                const nowPinned = !doc.data().pinned;
                
                await docRef.update({ pinned: nowPinned });
                if (nowPinned) {
                    await db.collection('vault_settings').doc('pin').set({ 
                        id: currentCtxId, 
                        author: doc.data().author, 
                        body: doc.data().body 
                    });
                } else {
                    await db.collection('vault_settings').doc('pin').delete();
                }
            },

            listenPins: () => {
                db.collection('vault_settings').doc('pin').onSnapshot(doc => {
                    const bar = document.getElementById('pin-bar');
                    if (doc.exists) {
                        bar.style.display = 'flex';
                        document.getElementById('pin-txt').innerText = `${doc.data().author}: ${doc.data().body}`;
                        bar.dataset.id = doc.data().id;
                    } else {
                        bar.style.display = 'none';
                    }
                });
            },

            jumpToPin: () => {
                const id = document.getElementById('pin-bar').dataset.id;
                document.getElementById('msg-' + id)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
            },

            ctxDelete: async () => {
                if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö?")) {
                    await db.collection('vault_msgs').doc(currentCtxId).delete();
                }
            },

            updatePresence: () => {
                if (user) db.collection('vault_users').doc(user.uid).update({ lastSeen: Date.now() });
            },

            listenPresence: () => {
                db.collection('vault_users').onSnapshot(snap => {
                    let count = 0;
                    const threshold = Date.now() - 60000;
                    snap.forEach(d => { if (d.data().lastSeen > threshold && d.data().status === 'approved') count++; });
                    document.getElementById('online-count').innerText = `${count} –≤ —Å–µ—Ç–∏`;
                });
            },

            logout: () => {
                localStorage.removeItem('vault_user');
                location.reload();
            }
        };

        window.onload = logic.init;

    </script>
</body>
</html>
